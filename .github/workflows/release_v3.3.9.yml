name: Release v3.3.9
on:
  workflow_dispatch:  # Change to manual trigger only

jobs:
  validate_and_release:
    name: Validate and Release v3.3.9
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Run Smart V3 Validator
        run: |
          echo "üöÄ Running V3.3.9 validation..."
          python scripts/smart_v3_validator.py
        
      - name: Check Validation Results
        run: |
          echo "üîç Checking validation results..."
          if [ -f "artifacts/v3-validation-report.json" ]; then
            echo "‚úÖ Validation report found"
            # Check for V3.3.9 validation
            if python -c "import json; data=json.load(open('artifacts/v3-validation-report.json')); exit(0 if '3.3.9' in str(data) else 1)"; then
              echo "‚úÖ Validation passed for V3.3.9"
            else
              echo "‚ùå Validation failed or wrong version"
              exit 1
            fi
          else
            echo "‚ùå No validation report found"
            exit 1
          fi
        
      - name: Build Package
        run: |
          echo "üì¶ Building package..."
          python -m build
          echo "‚úÖ Package built successfully"
          echo "Package files:"
          ls -la dist/
        
      - name: Verify Package
        run: |
          echo "üîç Verifying package..."
          python -m twine check dist/*
          echo "‚úÖ Package verification passed"
        
      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          echo "üì§ Publishing v3.3.9 to PyPI..."
          python -m twine upload dist/*
          echo "‚úÖ Published v3.3.9 to PyPI successfully!"
