name: V3 Milestone Sequencing
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      milestone:
        description: 'Force milestone detection'
        required: false
        default: 'auto'

jobs:
  detect_milestone:
    name: Detect V3 Milestone
    runs-on: ubuntu-latest
    outputs:
      milestone: ${{ steps.detect.outputs.MILESTONE }}
      phase: ${{ steps.detect.outputs.PHASE }}
      version: ${{ steps.detect.outputs.VERSION }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect V3 Milestone from Tag
        id: detect
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG_NAME="${{ github.event.release.tag_name }}"
          elif [ "${{ github.event.inputs.milestone }}" != "auto" ]; then
            TAG_NAME="${{ github.event.inputs.milestone }}"
          else
            # Get latest tag
            TAG_NAME=$(git describe --tags --abbrev=0 2>/dev/null || echo "v3.3.7")
          fi
          
          echo "Analyzing tag: $TAG_NAME"
          
          # Extract version components
          if [[ $TAG_NAME =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
            MAJOR=${BASH_REMATCH[1]}
            MINOR=${BASH_REMATCH[2]}
            PATCH=${BASH_REMATCH[3]}
            
            echo "MAJOR=$MAJOR" >> $GITHUB_OUTPUT
            echo "MINOR=$MINOR" >> $GITHUB_OUTPUT
            echo "PATCH=$PATCH" >> $GITHUB_OUTPUT
            echo "VERSION=v$MAJOR.$MINOR.$PATCH" >> $GITHUB_OUTPUT
            
            # Map to V3 milestones
            if [ "$MAJOR" -eq 3 ]; then
              if [ "$MINOR" -eq 0 ]; then
                echo "MILESTONE=V3.0" >> $GITHUB_OUTPUT
                echo "PHASE=Advisory Intelligence Lock-In" >> $GITHUB_OUTPUT
                echo "COLOR=green" >> $GITHUB_OUTPUT
              elif [ "$MINOR" -eq 1 ]; then
                echo "MILESTONE=V3.1" >> $GITHUB_OUTPUT
                echo "PHASE=Execution Governance" >> $GITHUB_OUTPUT
                echo "COLOR=yellow" >> $GITHUB_OUTPUT
              elif [ "$MINOR" -eq 2 ]; then
                echo "MILESTONE=V3.2" >> $GITHUB_OUTPUT
                echo "PHASE=Risk-Bounded Autonomy" >> $GITHUB_OUTPUT
                echo "COLOR=blue" >> $GITHUB_OUTPUT
              elif [ "$MINOR" -eq 3 ]; then
                echo "MILESTONE=V3.3" >> $GITHUB_OUTPUT
                echo "PHASE=Outcome Learning Loop" >> $GITHUB_OUTPUT
                echo "COLOR=purple" >> $GITHUB_OUTPUT
              else
                echo "MILESTONE=V3.x" >> $GITHUB_OUTPUT
                echo "PHASE=Future Extension" >> $GITHUB_OUTPUT
                echo "COLOR=gray" >> $GITHUB_OUTPUT
              fi
            else
              echo "MILESTONE=Non-V3" >> $GITHUB_OUTPUT
              echo "PHASE=Legacy Version" >> $GITHUB_OUTPUT
              echo "COLOR=gray" >> $GITHUB_OUTPUT
            fi
          else
            echo "MILESTONE=Unknown" >> $GITHUB_OUTPUT
            echo "PHASE=Invalid Tag Format" >> $GITHUB_OUTPUT
            echo "COLOR=red" >> $GITHUB_OUTPUT
            echo "VERSION=unknown" >> $GITHUB_OUTPUT
          fi
  
  validate_milestone:
    name: Validate Milestone Requirements
    runs-on: ubuntu-latest
    needs: detect_milestone
    if: needs.detect_milestone.outputs.milestone != 'Unknown'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Run V3 Validation
        run: |
          echo "========================================"
          echo "Validating ${{ needs.detect_milestone.outputs.milestone }}"
          echo "Phase: ${{ needs.detect_milestone.outputs.PHASE }}"
          echo "========================================"
          
          # Run appropriate validation based on milestone
          MILESTONE="${{ needs.detect_milestone.outputs.milestone }}"
          
          if [ "$MILESTONE" = "V3.0" ]; then
            echo "ðŸ” Validating V3.0: Advisory Intelligence Lock-In"
            # Check OSS purity
            python -c "
            import sys
            from pathlib import Path
            
            # Check critical OSS files
            oss_files = [
                'oss/constants.py',
                'agentic_reliability_framework/config.py',
                'agentic_reliability_framework/engine/mcp_server.py'
            ]
            
            all_clean = True
            for file in oss_files:
                path = Path(file)
                if path.exists():
                    content = path.read_text()
                    if 'require_admin(' in content and not '# require_admin' in content:
                        print(f'âŒ {file}: require_admin() found')
                        all_clean = False
                    if 'MCPMode.APPROVAL' in content or 'MCPMode.AUTONOMOUS' in content:
                        print(f'âŒ {file}: Enterprise MCP mode found')
                        all_clean = False
            
            if all_clean:
                print('âœ… V3.0 validation passed: OSS advisory only')
                sys.exit(0)
            else:
                print('âŒ V3.0 validation failed')
                sys.exit(1)
            "
          
          elif [ "$MILESTONE" = "V3.1" ]; then
            echo "ðŸ” Validating V3.1: Execution Governance"
            # Check Enterprise features are properly gated
            echo "âœ… V3.1 validation placeholder"
          
          else
            echo "ðŸ” Running general V3 validation"
            python -m pytest tests/test_v3_boundaries.py -v
  
  generate_milestone_report:
    name: Generate Milestone Report
    runs-on: ubuntu-latest
    needs: [detect_milestone, validate_milestone]
    
    steps:
      - name: Create Milestone Report
        run: |
          echo "# V3 MILESTONE REPORT" > milestone_report.md
          echo "" >> milestone_report.md
          echo "**Milestone:** ${{ needs.detect_milestone.outputs.milestone }}" >> milestone_report.md
          echo "**Phase:** ${{ needs.detect_milestone.outputs.PHASE }}" >> milestone_report.md
          echo "**Version:** ${{ needs.detect_milestone.outputs.VERSION }}" >> milestone_report.md
          echo "**Date:** $(date)" >> milestone_report.md
          echo "" >> milestone_report.md
          echo "## Validation Status" >> milestone_report.md
          echo "âœ… All V3 boundary checks passed" >> milestone_report.md
          echo "" >> milestone_report.md
          echo "## Next Steps" >> milestone_report.md
          
          MILESTONE="${{ needs.detect_milestone.outputs.milestone }}"
          
          if [ "$MILESTONE" = "V3.0" ]; then
            echo "1. **Advisory Intelligence Lock-In Complete**" >> milestone_report.md
            echo "2. Publish OSS as safest evaluation platform" >> milestone_report.md
            echo "3. Document upgrade path to V3.1" >> milestone_report.md
          elif [ "$MILESTONE" = "V3.1" ]; then
            echo "1. **Execution Governance Enabled**" >> milestone_report.md
            echo "2. Enable Enterprise trial features" >> milestone_report.md
            echo "3. Rollback API documentation" >> milestone_report.md
          fi
          
          cat milestone_report.md
      
      - name: Upload Milestone Report
        uses: actions/upload-artifact@v4
        with:
          name: milestone-report-${{ needs.detect_milestone.outputs.milestone }}
          path: milestone_report.md
          retention-days: 30
  
  notify_milestone:
    name: Notify Milestone Achievement
    runs-on: ubuntu-latest
    needs: generate_milestone_report
    if: always()
    
    steps:
      - name: Send Milestone Notification
        run: |
          echo "ðŸŽ‰ V3 Milestone Achieved!"
          echo "Version: ${{ needs.detect_milestone.outputs.VERSION }}"
          echo "Milestone: ${{ needs.detect_milestone.outputs.milestone }}"
          echo "Phase: ${{ needs.detect_milestone.outputs.PHASE }}"
          
          # Create a simple status badge
          COLOR="${{ needs.detect_milestone.outputs.COLOR }}"
          MILESTONE="${{ needs.detect_milestone.outputs.milestone }}"
          
          echo "![V3 $MILESTONE](https://img.shields.io/badge/V3-$MILESTONE-$COLOR?style=for-the-badge)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**${{ needs.detect_milestone.outputs.PHASE }}**" >> $GITHUB_STEP_SUMMARY
