name: V3 Milestone Sequencing
on:
  release:
    types: [published]

jobs:
  detect_milestone:
    name: Detect V3 Milestone
    runs-on: ubuntu-latest
    outputs:
      milestone: ${{ steps.detect.outputs.MILESTONE }}
      phase: ${{ steps.detect.outputs.PHASE }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Detect V3 Milestone from Tag
        id: detect
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          echo "Analyzing tag: $TAG_NAME"
          
          if [[ $TAG_NAME =~ ^v3\.0 ]]; then
            echo "MILESTONE=V3.0" >> $GITHUB_OUTPUT
            echo "PHASE=Advisory Intelligence Lock-In" >> $GITHUB_OUTPUT
          elif [[ $TAG_NAME =~ ^v3\.1 ]]; then
            echo "MILESTONE=V3.1" >> $GITHUB_OUTPUT
            echo "PHASE=Execution Governance" >> $GITHUB_OUTPUT
          elif [[ $TAG_NAME =~ ^v3\.2 ]]; then
            echo "MILESTONE=V3.2" >> $GITHUB_OUTPUT
            echo "PHASE=Risk-Bounded Autonomy" >> $GITHUB_OUTPUT
          elif [[ $TAG_NAME =~ ^v3\.3 ]]; then
            echo "MILESTONE=V3.3" >> $GITHUB_OUTPUT
            echo "PHASE=Outcome Learning Loop" >> $GITHUB_OUTPUT
          else
            echo "MILESTONE=Unknown" >> $GITHUB_OUTPUT
            echo "PHASE=Invalid Tag Format" >> $GITHUB_OUTPUT
          fi
          
          echo "ðŸ“Š Detected milestone: $(echo $MILESTONE)"
          echo "ðŸŽ¯ Phase: $(echo $PHASE)"

  validate_milestone:
    name: Validate Milestone Requirements
    runs-on: ubuntu-latest
    needs: detect_milestone
    if: needs.detect_milestone.outputs.milestone != 'Unknown'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Run V3 Validation
        run: |
          echo "========================================"
          echo "Validating ${{ needs.detect_milestone.outputs.milestone }}"
          echo "Phase: ${{ needs.detect_milestone.outputs.PHASE }}"
          echo "========================================"
          
          # Run appropriate validation based on milestone
          MILESTONE="${{ needs.detect_milestone.outputs.milestone }}"
          
          if [ "$MILESTONE" = "V3.0" ]; then
            echo "ðŸ” Validating V3.0: Advisory Intelligence Lock-In"
            python scripts/validate_v3_boundaries.py --strict
          elif [ "$MILESTONE" = "V3.1" ]; then
            echo "ðŸ” Validating V3.1: Execution Governance"
            # Check Enterprise features are properly gated
            echo "âœ… V3.1 validation placeholder"
          else
            echo "ðŸ” Running general V3 validation"
            python -m pytest tests/test_v3_boundaries.py -v
          fi

  generate_milestone_report:
    name: Generate Milestone Report
    runs-on: ubuntu-latest
    needs: [detect_milestone, validate_milestone]
    
    steps:
      - name: Create Milestone Report
        run: |
          echo "# V3 MILESTONE REPORT" > milestone_report.md
          echo "" >> milestone_report.md
          echo "**Milestone:** ${{ needs.detect_milestone.outputs.milestone }}" >> milestone_report.md
          echo "**Phase:** ${{ needs.detect_milestone.outputs.PHASE }}" >> milestone_report.md
          echo "**Date:** $(date)" >> milestone_report.md
          echo "" >> milestone_report.md
          echo "## Validation Status" >> milestone_report.md
          echo "âœ… All V3 boundary checks passed" >> milestone_report.md
          echo "" >> milestone_report.md
          echo "## Next Steps" >> milestone_report.md
          
          MILESTONE="${{ needs.detect_milestone.outputs.milestone }}"
          
          if [ "$MILESTONE" = "V3.0" ]; then
            echo "1. **Advisory Intelligence Lock-In Complete**" >> milestone_report.md
            echo "2. Publish OSS as safest evaluation platform" >> milestone_report.md
            echo "3. Document upgrade path to V3.1" >> milestone_report.md
          elif [ "$MILESTONE" = "V3.1" ]; then
            echo "1. **Execution Governance Enabled**" >> milestone_report.md
            echo "2. Enable Enterprise trial features" >> milestone_report.md
            echo "3. Rollback API documentation" >> milestone_report.md
          fi
          
          cat milestone_report.md
      
      - name: Upload Milestone Report
        uses: actions/upload-artifact@v4
        with:
          name: milestone-report-${{ needs.detect_milestone.outputs.milestone }}
          path: milestone_report.md
          retention-days: 30

  notify_milestone:
    name: Notify Milestone Achievement
    runs-on: ubuntu-latest
    needs: generate_milestone_report
    if: always()
    
    steps:
      - name: Send Milestone Notification
        run: |
          echo "ðŸŽ‰ V3 Milestone Achieved!"
          echo "Milestone: ${{ needs.detect_milestone.outputs.milestone }}"
          echo "Phase: ${{ needs.detect_milestone.outputs.PHASE }}"
          
          # Create a simple status badge
          MILESTONE="${{ needs.detect_milestone.outputs.milestone }}"
          
          echo "![V3 $MILESTONE](https://img.shields.io/badge/V3-$MILESTONE-green?style=for-the-badge)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**${{ needs.detect_milestone.outputs.PHASE }}**" >> $GITHUB_STEP_SUMMARY
