# .github/workflows/oss_tests.yml
name: OSS Boundary Tests

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'agentic_reliability_framework/arf_core/**'
      - 'scripts/**'

jobs:
  oss-boundary:
    name: OSS Boundary Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install astunparse
        
    - name: Run OSS purity check
      run: |
        python scripts/enforce_oss_purity.py
        
    - name: Check OSS constants
      run: |
        echo "Verifying OSS constant values..."
        
        # Create a simple Python script to check constants
        cat > check_constants.py << 'EOF'
        import sys
        sys.path.insert(0, 'agentic_reliability_framework')
        
        try:
            from arf_core.constants import *
            
            assert MAX_INCIDENT_HISTORY == 1000, f"MAX_INCIDENT_HISTORY must be 1000, got {MAX_INCIDENT_HISTORY}"
            assert MCP_MODES_ALLOWED == ("advisory",), f"MCP_MODES_ALLOWED must be only advisory, got {MCP_MODES_ALLOWED}"
            assert EXECUTION_ALLOWED == False, f"EXECUTION_ALLOWED must be False, got {EXECUTION_ALLOWED}"
            assert GRAPH_STORAGE == "in_memory", f"GRAPH_STORAGE must be in_memory, got {GRAPH_STORAGE}"
            
            print("✅ OSS constants are correct")
            
        except ImportError as e:
            print(f"❌ Failed to import OSS constants: {e}")
            sys.exit(1)
        except AssertionError as e:
            print(f"❌ OSS constant violation: {e}")
            sys.exit(1)
        EOF
        
        python check_constants.py
        
    - name: Check for mixed imports
      run: |
        echo "Checking for Enterprise code in OSS directories..."
        
        # Check OSS core directories
        OSS_DIRS="agentic_reliability_framework/arf_core agentic_reliability_framework/engine"
        
        for dir in $OSS_DIRS; do
          if [ -d "$dir" ]; then
            echo "Checking $dir..."
            
            # Check for Enterprise imports
            if grep -r "from arf_enterprise\|import arf_enterprise" "$dir" --include="*.py"; then
              echo "❌ Found Enterprise imports in $dir"
              exit 1
            fi
            
            # Check for Enterprise class references
            if grep -r "LicenseManager\|EnterpriseMCPServer\|audit_trail\|license_key" "$dir" --include="*.py"; then
              echo "❌ Found Enterprise code patterns in $dir"
              exit 1
            fi
          fi
        done
        
        echo "✅ OSS code boundaries are clean"
