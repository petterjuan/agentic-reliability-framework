# .github/workflows/oss_tests.yml
name: OSS Boundary Tests

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'agentic_reliability_framework/arf_core/**'
      - 'scripts/**'
      - '.github/workflows/oss_tests.yml'

jobs:
  oss-boundary:
    name: OSS Boundary Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: List OSS files
      run: |
        echo "üìÅ OSS File Structure:"
        find agentic_reliability_framework/arf_core -type f -name "*.py" | sort
        
    - name: Run OSS boundary check (with debug)
      run: |
        echo "üîç Running OSS boundary check with debug..."
        python scripts/oss_boundary_check.py --debug || true
        
    - name: Simple OSS validation
      run: |
        echo "üîç Simple OSS validation..."
        
        # Check critical files exist
        echo "1. Checking required files:"
        REQUIRED_FILES=(
          "agentic_reliability_framework/arf_core/__init__.py"
          "agentic_reliability_framework/arf_core/constants.py"
          "agentic_reliability_framework/arf_core/models/healing_intent.py"
          "agentic_reliability_framework/arf_core/engine/oss_mcp_client.py"
        )
        
        all_exist=true
        for file in "${REQUIRED_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "   ‚úÖ $file"
          else
            echo "   ‚ùå $file - MISSING"
            all_exist=false
          fi
        done
        
        if [ "$all_exist" = false ]; then
          echo "‚ùå Missing required OSS files"
          exit 1
        fi
        
        # Check constants.py content
        echo ""
        echo "2. Checking constants.py:"
        CONSTANTS_FILE="agentic_reliability_framework/arf_core/constants.py"
        if [ -f "$CONSTANTS_FILE" ]; then
          echo "   ‚úÖ File exists"
          
          # Check for OSS keywords
          if grep -q "advisory" "$CONSTANTS_FILE"; then
            echo "   ‚úÖ Contains 'advisory'"
          else
            echo "   ‚ö†Ô∏è  Does not contain 'advisory'"
          fi
          
          if grep -q "in_memory" "$CONSTANTS_FILE"; then
            echo "   ‚úÖ Contains 'in_memory'"
          else
            echo "   ‚ö†Ô∏è  Does not contain 'in_memory'"
          fi
          
          # Check for forbidden modes
          if grep -q "APPROVAL\|AUTONOMOUS" "$CONSTANTS_FILE"; then
            echo "   ‚ùå Contains non-advisory modes"
            exit 1
          else
            echo "   ‚úÖ Only advisory mode"
          fi
        else
          echo "   ‚ùå File missing"
          exit 1
        fi
        
        echo ""
        echo "üéâ Simple OSS validation passed!"
        
    - name: Check for Enterprise imports
      run: |
        echo "üîç Checking for Enterprise imports in OSS code..."
        
        # Only fail on these absolute no-nos
        ABSOLUTE_NO_NOS=(
          "EnterpriseMCPServer"
          "LicenseManager"
          "license_key"
          "validate_license"
          "ARF-ENT-"  # License key pattern
        )
        
        found_problems=0
        for pattern in "${ABSOLUTE_NO_NOS[@]}"; do
          echo "   Checking for: $pattern"
          if grep -r "$pattern" agentic_reliability_framework/arf_core/ --include="*.py" 2>/dev/null; then
            echo "   ‚ùå Found absolute no-no: $pattern"
            found_problems=1
          fi
        done
        
        if [ $found_problems -eq 0 ]; then
          echo "‚úÖ No absolute no-nos found in OSS code"
        else
          echo "‚ùå Absolute no-nos found - failing build"
          exit 1
        fi
