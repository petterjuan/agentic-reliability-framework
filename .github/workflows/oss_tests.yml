# .github/workflows/oss_tests.yml - SIMPLIFIED ROBUST VERSION
name: OSS Boundary Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  oss-boundary:
    name: OSS Boundary Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Basic OSS Structure Check
      run: |
        echo "üîç BASIC OSS STRUCTURE CHECK"
        echo "============================"
        
        # Check 1: Required directories exist
        echo "1. Checking required directories..."
        REQUIRED_DIRS=(
          "agentic_reliability_framework"
          "agentic_reliability_framework/arf_core"
          "agentic_reliability_framework/arf_core/models"
          "agentic_reliability_framework/arf_core/engine"
          "agentic_reliability_framework/arf_core/config"
        )
        
        all_dirs_exist=true
        for dir in "${REQUIRED_DIRS[@]}"; do
          if [ -d "$dir" ]; then
            echo "   ‚úÖ $dir exists"
          else
            echo "   ‚ùå $dir MISSING"
            all_dirs_exist=false
          fi
        done
        
        if [ "$all_dirs_exist" = false ]; then
          echo "‚ùå Missing required OSS directories"
          exit 1
        fi
        
        # Check 2: Required files exist
        echo ""
        echo "2. Checking required files..."
        REQUIRED_FILES=(
          "agentic_reliability_framework/__init__.py"
          "agentic_reliability_framework/arf_core/__init__.py"
          "agentic_reliability_framework/arf_core/constants.py"
          "agentic_reliability_framework/arf_core/models/healing_intent.py"
        )
        
        all_files_exist=true
        for file in "${REQUIRED_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "   ‚úÖ $file exists"
          else
            echo "   ‚ùå $file MISSING"
            all_files_exist=false
          fi
        done
        
        if [ "$all_files_exist" = false ]; then
          echo "‚ùå Missing required OSS files"
          exit 1
        fi
        
        # Check 3: Quick enterprise code check (simplified)
        echo ""
        echo "3. Quick enterprise code check..."
        
        # Use simple grep but exclude comments
        VIOLATIONS=0
        
        # Check for import statements with Enterprise
        if grep -r "^\s*import.*[Ee]ntreprise" agentic_reliability_framework/arf_core/ --include="*.py" 2>/dev/null | grep -v "#" | head -5; then
          echo "   ‚ùå Found 'import ...Enterprise...' in code (not comment)"
          VIOLATIONS=$((VIOLATIONS + 1))
        fi
        
        if grep -r "^\s*from.*[Ee]ntreprise" agentic_reliability_framework/arf_core/ --include="*.py" 2>/dev/null | grep -v "#" | head -5; then
          echo "   ‚ùå Found 'from ...Enterprise...' in code (not comment)"
          VIOLATIONS=$((VIOLATIONS + 1))
        fi
        
        # Check for class definitions with EnterpriseMCPServer
        if grep -r "^\s*class.*EnterpriseMCPServer" agentic_reliability_framework/arf_core/ --include="*.py" 2>/dev/null; then
          echo "   ‚ùå Found 'class ...EnterpriseMCPServer' definition"
          VIOLATIONS=$((VIOLATIONS + 1))
        fi
        
        if [ $VIOLATIONS -gt 0 ]; then
          echo "‚ùå Found $VIOLATIONS enterprise code violations"
          exit 1
        else
          echo "   ‚úÖ No obvious enterprise code violations"
        fi
        
        # Check 4: Can import basic OSS module
        echo ""
        echo "4. Testing basic import..."
        python3 -c "
        try:
            import agentic_reliability_framework
            print('   ‚úÖ Successfully imported agentic_reliability_framework')
            print(f'   Version: {agentic_reliability_framework.__version__}')
            
            # Try to import OSS core components
            from agentic_reliability_framework.arf_core import constants
            print(f'   ‚úÖ OSS constants: {constants.OSS_EDITION}')
            
            from agentic_reliability_framework.arf_core.models import healing_intent
            print('   ‚úÖ OSS healing_intent module available')
            
        except Exception as e:
            print(f'   ‚ùå Import failed: {e}')
            import traceback
            traceback.print_exc()
            exit(1)
        "
        
        echo ""
        echo "üéâ OSS BOUNDARY CHECK PASSED!"
        echo "============================="
        echo "‚úì All required directories exist"
        echo "‚úì All required files exist"
        echo "‚úì No enterprise code violations"
        echo "‚úì Basic imports work"
