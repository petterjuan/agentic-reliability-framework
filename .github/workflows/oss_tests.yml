# .github/workflows/oss_tests.yml
name: OSS Boundary Tests

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'agentic_reliability_framework/arf_core/**'
      - 'scripts/**'
      - '.github/workflows/oss_tests.yml'
  workflow_dispatch:  # Allow manual trigger

jobs:
  oss-boundary:
    name: OSS Boundary Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Ultra Simple OSS Check
      run: |
        echo "üîç ULTRA SIMPLE OSS BOUNDARY CHECK"
        echo "=================================="
        
        # 1. Check if arf_core directory exists
        echo ""
        echo "1. Checking arf_core directory..."
        if [ -d "agentic_reliability_framework/arf_core" ]; then
          echo "   ‚úÖ arf_core directory exists"
        else
          echo "   ‚ùå arf_core directory missing"
          exit 0  # Don't fail, just warn
        fi
        
        # 2. Check if constants.py exists
        echo ""
        echo "2. Checking constants.py..."
        if [ -f "agentic_reliability_framework/arf_core/constants.py" ]; then
          echo "   ‚úÖ constants.py exists"
          
          # Quick content check
          if grep -q "advisory" "agentic_reliability_framework/arf_core/constants.py"; then
            echo "   ‚úÖ Contains 'advisory' (OSS mode)"
          fi
          
          if grep -q "in_memory" "agentic_reliability_framework/arf_core/constants.py"; then
            echo "   ‚úÖ Contains 'in_memory' (OSS storage)"
          fi
        else
          echo "   ‚ö†Ô∏è  constants.py missing"
        fi
        
        # 3. Check for ABSOLUTE NO Enterprise code
        echo ""
        echo "3. Checking for Enterprise code (absolute no-nos)..."
        
        ABSOLUTE_NO_NOS=(
          "EnterpriseMCPServer"
          "LicenseManager"
          "ARF-ENT-"
          "license_key="
        )
        
        found_critical=0
        for pattern in "${ABSOLUTE_NO_NOS[@]}"; do
          echo "   Checking: $pattern"
          if grep -r "$pattern" agentic_reliability_framework/arf_core/ --include="*.py" 2>/dev/null; then
            echo "   ‚ùå FOUND CRITICAL: $pattern"
            found_critical=1
          fi
        done
        
        if [ $found_critical -eq 0 ]; then
          echo "   ‚úÖ No critical Enterprise code found"
        else
          echo ""
          echo "üö® CRITICAL: Enterprise code found in OSS package!"
          echo "This violates OSS/Enterprise separation."
          exit 1
        fi
        
        # 4. Success!
        echo ""
        echo "=================================="
        echo "üéâ OSS BOUNDARY CHECK PASSED!"
        echo ""
        echo "Summary:"
        echo "- OSS directory structure exists"
        echo "- No Enterprise code detected"
        echo "- Ready for Apache 2.0 release"
