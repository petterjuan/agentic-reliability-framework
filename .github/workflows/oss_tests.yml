# .github/workflows/oss_tests.yml - IMPROVED VERSION
name: OSS Boundary Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  oss-boundary:
    name: OSS Boundary Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Smart OSS Check
      run: |
        echo "üîç SMART OSS CHECK"
        echo "=================="
        
        echo "1. Checking OSS structure..."
        if [ -d "agentic_reliability_framework/arf_core" ]; then
          echo "   ‚úÖ arf_core exists"
        else
          echo "   ‚ö†Ô∏è  arf_core missing"
          exit 1
        fi
        
        echo "2. Checking for Enterprise code (smart check)..."
        
        # Use Python for smarter checking
        python3 << 'EOF'
        import os
        import re
        
        def check_file_for_enterprise(filepath):
            """Check if file contains actual Enterprise code, not just comments"""
            with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                content = f.read()
                
            # Remove comments and strings for checking
            lines = []
            in_string = False
            string_char = None
            for line in content.split('\n'):
                clean_line = ""
                i = 0
                while i < len(line):
                    if not in_string and line[i] in ('"', "'"):
                        in_string = True
                        string_char = line[i]
                        i += 1
                    elif in_string and line[i] == string_char:
                        in_string = False
                        string_char = None
                        i += 1
                    elif not in_string and line[i] == '#':
                        break  # Rest of line is comment
                    elif not in_string:
                        clean_line += line[i]
                        i += 1
                    else:
                        i += 1
                
                if clean_line.strip():
                    lines.append(clean_line)
            
            # Check cleaned content
            cleaned = '\n'.join(lines)
            
            # Look for problematic patterns (not in comments/strings)
            patterns = [
                r'import EnterpriseMCPServer',
                r'from.*EnterpriseMCPServer',
                r'class.*EnterpriseMCPServer',
                r'EnterpriseMCPServer\s*=',
                r'EnterpriseMCPServer\(',
            ]
            
            for pattern in patterns:
                if re.search(pattern, cleaned):
                    return True, f"Found pattern: {pattern}"
            
            return False, None
        
        # Check all Python files in arf_core
        arf_core_dir = "agentic_reliability_framework/arf_core"
        violations = []
        
        for root, dirs, files in os.walk(arf_core_dir):
            for file in files:
                if file.endswith('.py'):
                    filepath = os.path.join(root, file)
                    has_violation, reason = check_file_for_enterprise(filepath)
                    if has_violation:
                        violations.append(f"{filepath}: {reason}")
        
        if violations:
            print("üö® Enterprise code violations found:")
            for v in violations:
                print(f"  ‚Ä¢ {v}")
            exit(1)
        else:
            print("‚úÖ No Enterprise code violations found")
            print("‚úÖ OSS boundary check passed!")
        EOF
        
        echo ""
        echo "üéâ OSS CHECK PASSED!"
        echo "Basic OSS structure is valid."
